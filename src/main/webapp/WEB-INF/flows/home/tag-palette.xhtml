<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:p="http://primefaces.org/ui">
    
<script>
//<![CDATA[
$(document).ready(function() {
	$("#tag-palette-panel").on("mouseenter", ".each-tag", function() {
        $(this).find(".tag-menu").first().show();
    });
    
    $("#tag-palette-panel").on("mouseleave", ".each-tag", function() {
        $(this).find(".tag-menu").first().hide();
    });
    
    var currentTagGroupTabIndex = "0";

    $tab = $( "#tag-palette-panel" ).tabs({
         activate : function (e, ui) {
            currentTagGroupTabIndex = ui.newTab.index().toString();
            sessionStorage.setItem('tag-palette-tab-index', currentTagGroupTabIndex);
         }
    });

    if (sessionStorage.getItem('tag-palette-tab-index')) {
        currentTagGroupTabIndex = sessionStorage.getItem('tag-palette-tab-index');
        $tab.tabs('option', 'active', currentTagGroupTabIndex);
    }
    
    setContextMenuForTags();
}); // end of $(document).ready()

function setContextMenuForTags() {
   	var menu = $("#tag-context-menu");
   	
	$(".each-tag").bind("contextmenu", function(event) {
    	menu.css({ left:event.pageX, top:event.pageY }).show();
    	var target = $(event.target).closest(".each-tag");
    	menu.data("target-tag", target);
    	$("#tag-palette-form\\:id-placeholder-for-tag").val(target.attr("_tid"));
    	event.preventDefault();
    });

    $(document).bind("click", function(event) {
    	menu.hide();
    });
}

function onExpandComplete() {
	setContextMenuForTags();
	setupDraggableForTags();
}

function showTagEditor() {
	var dlg = PF("tagEditor");
	dlg.show();
	
	var menu = $("#tag-context-menu");
	var target = menu.data("target-tag");
	var tagName = target.find(".each-tag-name").text();
	if (tagName == "") {
		tagName = "~unnamed~"
	}
	
	var inplace = PF("tagNameInplace");
	var display = inplace.jq.find(".ui-inplace-display");
	display.text(tagName)[0].title="#{msg['click_to_rename']}";
	var input = inplace.jq.find(".ui-inplace-content input");
	input.val(tagName);
	inplace.hide();
	
	function abortInput(val) {
		input.val(tagName);
		display.text(tagName);
	}
	
	function commitInput() {
		var val = input.val();
		if (! val || val == "") {
			abortInput(val);
		}
		else {
			display.text(val);
		}
		inplace.hide();
	}
	
	dlg.jq.find("#tag-palette-form\\:tag-name-panel").click(function(e) {
		if (e.target != input[0] && input.is(":visible")) {
			commitInput();
		}
	});
	
	input.keypress(function(e) {
		// [TODO] key check should be in a cross-browser way
		if (e.keyCode == 13 && input.is(":visible")) {
			commitInput();
			e.preventDefault();
			return false;
		}
	});
}

//]]>
</script> 

<div>
    <span id="tag-palette-title" class="fa fa-tags" >&nbsp;&nbsp;#{msg['label_tag_palette']}</span>
</div>

<h:form id="tag-palette-form">
    <p:dialog id="tag-editor" header="#{msg['label_edit']}" width="600px" modal="false" showEffect="fade" widgetVar="tagEditor" position="center" draggable="true" resizable="false" >
    	<p:panel id="tag-name-panel">
	    	<div class="fa fa-tag">&nbsp;&nbsp;
		    	<p:inplace widgetVar="tagNameInplace">
		            <p:inputText style="width:80%" value="#{paramTagBean.tag.tagName}"/>
		        </p:inplace>
	    	</div>
    	</p:panel>
    	<br/>
    	<h:panelGrid columns="2" cellpadding="10">
    		<f:facet name="header">
	        	<div class="fa fa-arrow-up"></div>
	        	<div class="fa fa-arrow-down"></div>
    		</f:facet>
	        <p:panel>
	            <div class="fa fa-tag">
	                &nbsp;&nbsp;
	                <p:inplace editor="true" label="+" saveLabel="#{msg['label_save']}" cancelLabel="#{msg['label_cancel']}">
	                	<p:ajax event="save" update="parent-tags"/>
						<p:selectOneListbox value="#{tagListBean.newParentTagId}" scrollHeight="#{cfg['tag.editor.sel.list.scrl.hgt']}" filter="true" filterMatchMode="contains">
					    	<f:selectItems value="#{tagListBean.listOfSelectableParents()}" var="tag" itemLabel="#{tag.tagName}" itemValue="#{tag.id}" />
						</p:selectOneListbox>
		            </p:inplace>
	            </div><br/>
	            <h:panelGroup id="parent-tags">
	        		<ui:repeat var="parent" value="#{tagListBean.parentTags}">
	        			<span class="fa fa-tag">&nbsp;&nbsp;#{parent.tagName}&nbsp;&nbsp;</span>
	        			<p:commandLink update=":tag-palette-form:parent-tags" action="#{tagListBean.removeParentTag(parent.id)}" styleClass="fa fa-minus-circle button-link" />
	        			<br/>
	        		</ui:repeat>
	            </h:panelGroup>
	        </p:panel>
	        <p:panel>
	            <div class="fa fa-tag">
                    &nbsp;&nbsp;
                    <p:inplace editor="true" label="+" saveLabel="#{msg['label_save']}" cancelLabel="#{msg['label_cancel']}">
                    	<p:ajax event="save" update="child-tags"/>
						<p:selectOneListbox value="#{tagListBean.newChildTagId}" scrollHeight="#{cfg['tag.editor.sel.list.scrl.hgt']}" filter="true" filterMatchMode="contains">
					    	<f:selectItems value="#{tagListBean.listOfSelectableChildren()}" var="tag" itemLabel="#{tag.tagName}" itemValue="#{tag.id}" />
						</p:selectOneListbox>
                    </p:inplace>
                </div><br/>
                <h:panelGroup id="child-tags">
	        		<ui:repeat var="child" value="#{tagListBean.childTags}">
	        			<span class="fa fa-tag">&nbsp;&nbsp;#{child.tagName}&nbsp;&nbsp;</span>
	        			<p:commandLink update=":tag-palette-form:child-tags" action="#{tagListBean.removeChildTag(child.id)}" styleClass="fa fa-minus-circle button-link" />
	        			<br/>
	        		</ui:repeat>
                </h:panelGroup>
	        </p:panel>
    	</h:panelGrid>
        <p:commandButton action="save-tag" value="#{msg['label_save']}" icon="ui-icon-check"/>
    </p:dialog>
    
    <div id="tag-context-menu" style="display:none; z-index:5000; position:absolute;">
	    <p:menu>
            <p:menuitem styleClass="fa" oncomplete="showTagEditor()" value="&#xf040; #{msg['label_edit']}"
            	update="tag-editor" actionListener="#{mainController.prepareTagListBeanToEditTag(tagListBean, paramTagBean)}"/>
            <p:menuitem styleClass="fa" onclick="confirmTrashingTagFromCtxtMenu()" value="&#xf1f8; #{msg['label_trash']}"/>
	    </p:menu>
    </div>
    
    <h:inputHidden id="id-placeholder-for-tag" value="#{paramTagBean.tag.id}" />
    
    <div id="tag-palette-panel">
        <ul>
            <li>
                <a href="#tag-palette-flat" title="#{msg['label_flat_view']}" >
                    <span class="fa fa-list fa-2x" ></span>
                </a>
            </li>
            <li>
                <a href="#tag-palette-tree" title="#{msg['label_tree_view']}" >
                    <span class="fa fa-tree fa-2x" ></span>
                </a>
            </li>
        </ul>
        
        <h:panelGrid columns="2" id="target-panel-selector" columnClasses="target-panel-selector-col-0, target-panel-selector-col-1" >
	        <label class="fa fa-file-text" for="panel-radio-for-tag-palette" >&nbsp;&nbsp;#{msg['label_panel']}</label>
	        <p:selectOneRadio id="panel-radio-for-tag-palette" value="#{customParams.panelIdForTagPalette}">
	            <f:selectItem itemLabel="0" itemValue="0" />
	            <f:selectItem itemLabel="1" itemValue="1" />
	            <f:selectItem itemLabel="2" itemValue="2" />
	        </p:selectOneRadio>
	    </h:panelGrid>
	    
	    <div id="trashcan">
		    <p:commandLink action="filter-by-tag" title="#{msg['go_to_trashcan']}">
		        <span class="fa fa-trash fa-2x button-link" style="color:lightgray"></span>
		        <f:param name="tagId" value="0" />
		    </p:commandLink>
		</div>
	    
        <div id="tag-palette-flat">
            <c:forEach var="tagBean" items="#{tagListBean.tagBeans}">
                <c:set var="tag" value="#{tagBean.tag}"/>
                <ui:include src="each-tag.xhtml" />
                <br/>
            </c:forEach>
        </div>
        <div id="tag-palette-tree">
            <p:tree value="#{tagListBean.tagTree.root}" var="tagBean" dynamic="true" style="width:100%">
            	<p:ajax event="expand" listener="#{tagListBean.tagTree.onNodeExpand}" oncomplete="onExpandComplete()"/>
            	<p:ajax event="collapse" listener="#{tagListBean.tagTree.onNodeCollapse}" />
                <c:set var="tag" value="#{tagBean.tag}"/>
                <p:treeNode>
                    <ui:include src="each-tag.xhtml" />
                </p:treeNode>
            </p:tree>
        </div>
    </div>
</h:form>

</ui:composition>