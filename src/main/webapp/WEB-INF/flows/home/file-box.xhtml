<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:p="http://primefaces.org/ui">
    
<script>
//<![CDATA[
$(document).ready(function() {
	$("#file-path-tree").on("mouseenter", ".each-file", function() {
		var menu = $(this).find(".file-menu");
		if (menu.attr("_isFolder") !== "true") {
	        menu.css("visibility", "visible");
		}
    });
    
    $("#file-path-tree").on("mouseleave", ".each-file", function() {
        $(this).find(".file-menu").css("visibility", "hidden");
    });
    
	$("#file-box-form\\:file-selector").change(function () {
	    var fileName = $(this).val();
	    if (fileName) {
	    	// make the upload button visible only when we have a file to upload
	    	$("#file-box-form\\:upload-button").css("visibility", "visible").effect("shake");
	    	
	    	var holderForDestId = $("#file-box-form\\:id-placeholder-for-selected-node");
	    	var dest = $("#file-path-tree .fa-upload");
	    	var path;
	    	if (dest.length > 0) {
	    		// a destination place has been specified
	    		path = dest.attr("_fp");
	    		holderForDestId.val(dest.attr("_id"));
	    	}
	    	else {
	    		// no destination place has been specified. just send the file in the root directory
	    		path = "/";
	    		holderForDestId.val(0);
	    	}
	    	
	    	$("#upload-destination-info").html("&nbsp;&nbsp;<span class='fa fa-folder-open' style='color:gold; font-weight:bold'>" + path + "</span>");
	    }
	});
	
	$(".file-path-tree-node").click(function () {
		$(".file-path-tree-node").removeClass("fa-upload");
		var $this = $(this);
		if ($this.attr("_isFolder") === "true") {
			var id = $this.attr("_id");
			$this.addClass("fa-upload");
		}
	});
}); // end of $(document).ready()

function showRenameFileDialog(fileId, filePath) {
	alert("yet to be implemented!");
}
//]]>
</script>

<div>
    <span id="file-box-title" class="fa fa-file" >&nbsp;&nbsp;#{msg['label_filebox']}</span>
</div>

<h:form id="file-box-form" enctype="multipart/form-data">
	<p:panel id="file-box-panel" >
        <h:inputHidden id="id-placeholder-for-selected-node" value="#{fileListBean.selectedNodeId}" />

		<!-- [TODO] externalize any other configurable parameters like this file size limit value -->
		<p:fileUpload id="file-selector" value="#{fileUploadBean.file}" mode="simple" skinSimple="true" sizeLimit="#{cfg['file.upload.size.limit']}" style="width:200px"/>
		<br/>
		
		<p:commandLink id="upload-button" action="upload-file" ajax="false" title="#{msg['label_upload_file']}">
			<span class="fa fa-2x fa-upload button-link ui-button"></span>
		</p:commandLink>
		
		<span id="upload-destination-info"></span>
		
		<div id="file-path-tree">
            <p:tree value="#{fileListBean.filePathTree.root}" var="filePathBean" style="width:100%">
                <p:treeNode styleClass="each-file">
                	<c:set var="isFolder" value="#{filePathBean.isFolder()}"/>
                    <span class="file-path-tree-node fa" _id="#{filePathBean.id}" _fp="#{filePathBean.fullPath}" _isFolder="#{isFolder}" style="color:#{filePathBean.toColorNotation()}">
                    	#{filePathBean}
                    </span>
                    <span class="file-menu" _isFolder="#{isFolder}">
					    <p:commandLink oncomplete="showRenameFileDialog('#{filePathBean.id}', '#{filePathBean}')" styleClass="file-button" title="#{msg['label_rename_file']}">
					        <span class="fa fa-pencil" style="color:black" >&nbsp;</span>
					    </p:commandLink>
						<p:commandLink oncomplete="confirmDeletingFile('#{filePathBean.id}')" styleClass="file-button" title="#{msg['label_delete_file']}">
					        <span class="fa fa-trash" style="color:indigo" >&nbsp;</span>
					    </p:commandLink>
					</span>
                </p:treeNode>
            </p:tree>
        </div>
	</p:panel>
</h:form>

</ui:composition>