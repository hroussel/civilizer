<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core" 
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	template="/WEB-INF/layouts/standard.xhtml">
                
<ui:define name="entry-point-scripts">
<script>
//<![CDATA[
$(document).ready(function() {
    $("#fragment-group").on("mouseenter", ".each-fragment-container", function() {
   		$(this).find(".fragment-menu").show();
   	});
    
    $("#fragment-group").on("mouseleave", ".each-fragment-container", function() {
   		$(this).find(".fragment-menu").hide();
   	});
    
    $(".fragment-content").each(function(){
    	var $this = $(this);
        var content = $this.text();
   	    $this.html(parseMarkdown(content));
   	});
    
    function generateClickHandler(panelId) {
    	var fragmentCount = $("#fragment-panel-" + panelId + " .each-fragment-container").length;
        if (fragmentCount > 0) {
            var fragmentCheckboxSlaves = [];    
            
            for (var j=0; j<fragmentCount; ++j) {
                var cb = PF("fragmentCheckboxSlave" + panelId + "_" + j);
                fragmentCheckboxSlaves.push(cb);
            }
        
            var fragmentCheckboxMaster = PF("fragmentCheckboxMaster" + panelId);
            
            // Align the master checkbox with its slaves in horizontal position
            fragmentCheckboxMaster.jq.offset({ left:fragmentCheckboxSlaves[0].jq.offset().left });
            
            return function (e) {
                if (fragmentCheckboxMaster.isChecked()) {
                    for (var i=0; i<fragmentCount; ++i) {
                        fragmentCheckboxSlaves[i].check();
                    }
                }
                else {
                    for (var i=0; i<fragmentCount; ++i) {
                        fragmentCheckboxSlaves[i].uncheck();
                    }
                }
            }
        }
    }
    
    var fragmentCheckboxMaster;
    var panelId;
    
    panelId = 0;
    fragmentCheckboxMaster = PF("fragmentCheckboxMaster" + panelId)
    if (fragmentCheckboxMaster) {
    	fragmentCheckboxMaster.jq.click(generateClickHandler(panelId));
    }
    panelId = 1;
    fragmentCheckboxMaster = PF("fragmentCheckboxMaster" + panelId)
    if (fragmentCheckboxMaster) {
    	fragmentCheckboxMaster.jq.click(generateClickHandler(panelId));
    }
    panelId = 2;
    fragmentCheckboxMaster = PF("fragmentCheckboxMaster" + panelId)
    if (fragmentCheckboxMaster) {
    	fragmentCheckboxMaster.jq.click(generateClickHandler(panelId));
    }
}); // end of $(document).ready()

function showSortOptionDialog(panelId) {
	PF('sortOptionDlg' + panelId).show();
}

function fragmentCheckBoxesAreChecked(panelId) {
	var fragmentCount = $("#fragment-panel-" + panelId + " .each-fragment-container").length;
    if (fragmentCount > 0) {
        for (var j=0; j<fragmentCount; ++j) {
            var cb = PF("fragmentCheckboxSlave" + panelId + "_" + j);
            if (cb.isChecked()) {
            	return true;
            }
        }
    }
    return false;
}

function showError(message) {
	$('#fragment-group-form\\:error-dlg-msg').text(message);
	PF("errorMsgDlg").show();
}

function confirmTrashingFragments(panelId, fid, deleting, bulk) {
	if (bulk) {
        if (fragmentCheckBoxesAreChecked(panelId) == false) {
            showError("#{msg['no_fragment_is_selected']}");
            return;
        }
    }
	
	var message = deleting ? "#{msg['confirm_deleting_fragments']}" : "#{msg['confirm_trashing_fragments']}";
	$('#fragment-group-form\\:confirm-dlg-msg').text(message);
    
    var yesBtn = $('[id^="fragment-group-form\\:confirm-dlg-yes-btn-"]');
    yesBtn.hide();
    
    if (deleting) {
        if (bulk) {
        	yesBtn.eq(3).show();
        }
        else {
        	yesBtn.eq(1).show();
        }
    }
    else {
        if (bulk) {
        	yesBtn.eq(2).show();
        }
        else {
        	yesBtn.eq(0).show();
        }
    }
    
    PF('singletonConfirmDlg').show();
    
    $("#fragment-group-form\\:id-placeholder-for-trashed-fragment").val(fid);
}

function confirmTrashingTag(tagId, deleting) {
	var message = deleting ? "#{msg['confirm_deleting_tag']}" : "#{msg['confirm_trashing_fragments_with_tag']}";
    $('#fragment-group-form\\:confirm-dlg-msg').text(message);
    
    var yesBtn = $('[id^="fragment-group-form\\:confirm-dlg-yes-btn-"]');
    yesBtn.hide();
    
    if (deleting) {
    	yesBtn.eq(5).show();
    }
    else {
    	yesBtn.eq(4).show();
    }
    
    PF('singletonConfirmDlg').show();
    
    $("#fragment-group-form\\:id-placeholder-for-trashed-tag").val(tagId);
}


//]]>
</script>
</ui:define>

<ui:define name="content">

<h:form id="fragment-group-form">
<!--     <p:log id="log" /> -->
    <p:growl id="growl" showDetail="true" sticky="false" life="10000" />
    
    <h:inputHidden id="id-placeholder-for-trashed-fragment" value="#{userEditedFragmentBean.fragment.id}" />
    <h:inputHidden id="id-placeholder-for-trashed-tag" value="#{userEditedTagBean.tag.id}" />
    
    <p:confirmDialog header="#{msg['label_error']}" severity="alert" closeOnEscape="true" widgetVar="errorMsgDlg" showEffect="fade" hideEffect="explode">
        <f:facet name="message">
            <h:outputText id="error-dlg-msg" styleClass="warning-color" value="&nbsp;"/>
        </f:facet>
        <p:commandButton value="#{msg['label_ok']}" icon="ui-icon-check" onclick="PF('errorMsgDlg').hide();" type="button" />
    </p:confirmDialog>
    
    <p:confirmDialog header="#{msg['are_you_sure']}" width="450px" severity="alert" widgetVar="singletonConfirmDlg" showEffect="fade" hideEffect="fade">
        <f:facet name="message">
            <h:outputText id="confirm-dlg-msg" value="&nbsp;" />
        </f:facet>

        <p:commandButton id="confirm-dlg-yes-btn-trash-fragment" value="#{msg['label_yes']}" action="trash-fragment" oncomplete="PF('singletonConfirmDlg').hide()"/>
        <p:commandButton id="confirm-dlg-yes-btn-delete-fragment" value="#{msg['label_yes']}" action="delete-fragment" oncomplete="PF('singletonConfirmDlg').hide()"/>
        <p:commandButton id="confirm-dlg-yes-btn-trash-fragments" value="#{msg['label_yes']}" action="trash-fragments" oncomplete="PF('singletonConfirmDlg').hide()"/>
        <p:commandButton id="confirm-dlg-yes-btn-delete-fragments" value="#{msg['label_yes']}" action="delete-fragments" oncomplete="PF('singletonConfirmDlg').hide()"/>
        <p:commandButton id="confirm-dlg-yes-btn-trash-tag" value="#{msg['label_yes']}" action="trash-tag" oncomplete="PF('singletonConfirmDlg').hide()"/>
        <p:commandButton id="confirm-dlg-yes-btn-delete-tag" value="#{msg['label_yes']}" action="delete-tag" oncomplete="PF('singletonConfirmDlg').hide()"/>

        <p:commandButton value="#{msg['label_no']}" onclick="PF('singletonConfirmDlg').hide();" type="button" />
    </p:confirmDialog>
    
    <div id="fragment-group">
        <c:set var="panelId" value="0" />
	    <div id="fragment-panel-#{panelId}">
	        <c:set var="fragmentListBean" value="#{fragmentListBeans[panelId]}"/>
	        <c:set var="panelContext" value="#{fragmentListBean.panelContextBean}" />
            <c:set var="curTagId" value="#{panelContext.tagId}" />
            <c:set var="curPage" value="#{panelContext.curPage}" />
            
            <p:dialog header="#{msg['label_choose_sort_option']}" modal="true" width="230px" showEffect="fade" widgetVar="sortOptionDlg#{panelId}" position="center" draggable="false" resizable="false" >
                <div id="fragment-sort-option-container" >
                    <p:selectOneListbox value="#{fragmentListBean.orderOption}">
                        <f:selectItem itemLabel="#{msg['label_by_updated_time']}" itemValue="0" />
                        <f:selectItem itemLabel="#{msg['label_by_created_time']}" itemValue="1" />
                        <f:selectItem itemLabel="#{msg['label_by_title']}" itemValue="2" />
                        <f:selectItem itemLabel="#{msg['label_by_id']}" itemValue="3" />
                    </p:selectOneListbox>
                </div>
                <br /><br />
                <p:inputSwitch value="#{fragmentListBean.orderAsc}" styleClass="fa" onLabel="&#xf160;" offLabel="&#xf161;" />
                <br />
	            <p:commandButton action="sort-fragments" value="#{msg['label_go_sort']}" icon="ui-icon-check">
	                <f:param name="curTagId" value="#{curTagId}"/>
                    <f:param name="curPage" value="#{curPage}"/>
	            </p:commandButton>
            </p:dialog>
	        
	        <p:panel id="fragment-panel-toolbar-#{panelId}" >
		        <p:selectBooleanCheckbox id="checkbox-for-all-fragments-#{panelId}" rendered="#{fragmentListBean.hasFragments()}" itemLabel="&nbsp;" widgetVar="fragmentCheckboxMaster${panelId}" />
		        <p:tooltip for="checkbox-for-all-fragments-#{panelId}" value="#{msg['label_check_uncheck_all_fragments']}" />
		        
		        <a href="#editor-frame" class="new-fragment-editor-trigger-on-toolbar" title="#{msg['label_new_fragment']}">
			        <span class="fa fa-plus-square fa-2x new-resource-color button-link"></span>
		        </a>
		        
		        <p:spacer width="20" />
		        
		        <p:commandLink rendered="#{!panelContext.isFirstPage()}" action="prev-fragment-page">
		            <f:param name="curTagId" value="#{curTagId}"/>
		            <f:param name="curPage" value="#{curPage}"/>
			        <span class="fa fa-step-backward fa-2x button-link" title="#{msg['label_go_to_prev_page']}"></span>
		        </p:commandLink>
		        
		        <p:spacer width="20" />
		        
		        <p:commandLink rendered="#{!panelContext.isLastPage()}" action="next-fragment-page">
		            <f:param name="curTagId" value="#{curTagId}"/>
                    <f:param name="curPage" value="#{curPage}"/>
			        <span class="fa fa-step-forward fa-2x button-link" title="#{msg['label_go_to_next_page']}"></span>
		        </p:commandLink>
		        
		        <p:spacer width="20" />
		        
		        <p:commandLink action="go-home">
			        <span class="fa fa-home fa-2x button-link" title="#{msg['label_go_home']}"></span>
		        </p:commandLink>
		        
		        <p:spacer width="20" />

		        <p:commandLink oncomplete="showSortOptionDialog('#{panelId}')" >
			        <span class="fa fa-sort fa-2x button-link" title="#{msg['label_sort_fragments']}"></span>
		        </p:commandLink>
		        
		        <p:spacer width="20" />
		        
		        <c:choose>
                    <c:when test="#{panelContext.fragmentDeletable}">
                        <p:commandLink oncomplete="confirmTrashingFragments('#{panelId}', null, true, true)" >
		                    <span class="fa fa-trash fa-2x button-link warning-color" title="#{msg['label_delete_fragment']}"></span>
		                </p:commandLink>
                    </c:when>
                    <c:otherwise>
                        <p:commandLink oncomplete="confirmTrashingFragments('#{panelId}', null, false, true)" >
		                    <span class="fa fa-trash fa-2x button-link" title="#{msg['label_trash_fragment']}"></span>
		                </p:commandLink>
                    </c:otherwise>
                </c:choose>
	        </p:panel> <!-- id="fragment-panel-toolbar-#{panelId}" -->
		    
		    <c:forEach var="fragmentBean" items="#{fragmentListBean.fragmentBeans}" varStatus="loop">
		        <ui:include src="each-fragment.xhtml" />
		    </c:forEach>
	    </div>
	    
	    <c:set var="panelId" value="1" />
        <div id="fragment-panel-#{panelId}">
            <p>&nbsp;</p>
        </div>
        
        <c:set var="panelId" value="2" />
        <div id="fragment-panel-#{panelId}">
            <p>&nbsp;</p>
        </div>
    </div>
</h:form>

</ui:define> <!-- end of content -->

<ui:define name="sidebar">
    <ui:include src="sidebar.xhtml"></ui:include>
</ui:define>

<ui:define name="footer"></ui:define>


</ui:composition>
